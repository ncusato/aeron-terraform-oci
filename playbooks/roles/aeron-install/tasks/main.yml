---
- name: Create Aeron directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ aeron_dir }}"
    - "{{ aeron_dir }}/bin"
    - "{{ aeron_dir }}/lib"
    - "{{ aeron_dir }}/logs"
    - "{{ aeron_dir }}/results"
    - "/dev/shm/aeron"

- name: Ensure git is installed
  apt:
    name: git
    state: present
    update_cache: yes
  when: ansible_os_family == 'Debian'

- name: Ensure git is installed (RHEL)
  yum:
    name: git
    state: present
  when: ansible_os_family == 'RedHat'

- name: Install Java {{ java_version }} (Ubuntu)
  apt:
    name: "openjdk-{{ java_version }}-jdk"
    state: present
  when: ansible_os_family == 'Debian'

- name: Install Java {{ java_version }} (RHEL)
  yum:
    name: "java-{{ java_version }}-openjdk-devel"
    state: present
  when: ansible_os_family == 'RedHat'

- name: Set JAVA_HOME for Ubuntu
  lineinfile:
    path: /etc/environment
    line: "JAVA_HOME=/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
    create: yes
  when: ansible_os_family == 'Debian'

- name: Set JAVA_HOME for RHEL
  lineinfile:
    path: /etc/environment
    line: "JAVA_HOME=/usr/lib/jvm/java-{{ java_version }}-openjdk"
    create: yes
  when: ansible_os_family == 'RedHat'

- name: Clone Aeron repository
  git:
    repo: "{{ aeron_git_repo }}"
    dest: "{{ aeron_dir }}/aeron-src"
    version: "{{ aeron_git_branch | default('master', true) }}"
    force: yes
  register: aeron_clone

- name: Build Aeron with Gradle
  shell: |
    export JAVA_HOME=/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64
    ./gradlew clean
    ./gradlew assemble -x javadoc
  args:
    chdir: "{{ aeron_dir }}/aeron-src"
  environment:
    JAVA_HOME: "/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
  when: aeron_clone.changed or force_rebuild | default(false)

- name: Find built Aeron jars
  find:
    paths: "{{ aeron_dir }}/aeron-src"
    patterns: "*.jar"
    recurse: yes
    file_type: file
  register: aeron_jars

- name: Copy Aeron jars to lib directory
  copy:
    src: "{{ item.path }}"
    dest: "{{ aeron_dir }}/lib/"
    remote_src: yes
    mode: '0644'
  loop: "{{ aeron_jars.files }}"
  when: "'build/libs' in item.path and 'sources' not in item.path and 'javadoc' not in item.path"

- name: Create media driver script
  copy:
    dest: "{{ aeron_dir }}/bin/media-driver.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      AERON_DIR="{{ aeron_dir }}"
      JAVA_HOME="/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
      
      export JAVA_OPTS="{{ aeron_java_opts }}"
      
      $JAVA_HOME/bin/java $JAVA_OPTS \
        -cp "$AERON_DIR/lib/*:$AERON_DIR/aeron-src/aeron-samples/build/libs/*:$AERON_DIR/aeron-src/aeron-all/build/libs/*" \
        io.aeron.driver.MediaDriver \
        "$@"

- name: Create benchmark ping script
  copy:
    dest: "{{ aeron_dir }}/bin/ping.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      AERON_DIR="{{ aeron_dir }}"
      JAVA_HOME="/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
      
      MESSAGE_SIZE=${1:-32}
      MESSAGES=${2:-1000000}
      
      export JAVA_OPTS="{{ aeron_java_opts }}"
      
      $JAVA_HOME/bin/java $JAVA_OPTS \
        -cp "$AERON_DIR/lib/*:$AERON_DIR/aeron-src/aeron-samples/build/libs/*:$AERON_DIR/aeron-src/aeron-all/build/libs/*" \
        io.aeron.samples.Ping \
        -c aeron:udp?endpoint=localhost:20121 \
        -m $MESSAGE_SIZE \
        -n $MESSAGES \
        "$@"

- name: Create benchmark pong script
  copy:
    dest: "{{ aeron_dir }}/bin/pong.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      AERON_DIR="{{ aeron_dir }}"
      JAVA_HOME="/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
      
      export JAVA_OPTS="{{ aeron_java_opts }}"
      
      $JAVA_HOME/bin/java $JAVA_OPTS \
        -cp "$AERON_DIR/lib/*:$AERON_DIR/aeron-src/aeron-samples/build/libs/*:$AERON_DIR/aeron-src/aeron-all/build/libs/*" \
        io.aeron.samples.Pong \
        -c aeron:udp?endpoint=localhost:20121 \
        "$@"

- name: Create throughput benchmark script
  copy:
    dest: "{{ aeron_dir }}/bin/throughput.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      AERON_DIR="{{ aeron_dir }}"
      JAVA_HOME="/usr/lib/jvm/java-{{ java_version }}-openjdk-amd64"
      
      MESSAGE_SIZE=${1:-32}
      MESSAGES=${2:-100000000}
      
      export JAVA_OPTS="{{ aeron_java_opts }}"
      
      $JAVA_HOME/bin/java $JAVA_OPTS \
        -cp "$AERON_DIR/lib/*:$AERON_DIR/aeron-src/aeron-samples/build/libs/*:$AERON_DIR/aeron-src/aeron-all/build/libs/*" \
        io.aeron.samples.StreamingPublisher \
        -c aeron:udp?endpoint=localhost:20121 \
        -m $MESSAGE_SIZE \
        -n $MESSAGES \
        "$@"

- name: Configure sysctl for Aeron
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-aeron.conf
    reload: yes
  loop:
    - { name: 'net.core.rmem_max', value: '8388608' }
    - { name: 'net.core.wmem_max', value: '8388608' }
    - { name: 'net.core.rmem_default', value: '1048576' }
    - { name: 'net.core.wmem_default', value: '1048576' }
    - { name: 'net.core.netdev_max_backlog', value: '30000' }
    - { name: 'vm.swappiness', value: '10' }

- name: Set ulimits for Aeron
  pam_limits:
    domain: '*'
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop:
    - { type: 'soft', item: 'nofile', value: '1048576' }
    - { type: 'hard', item: 'nofile', value: '1048576' }
    - { type: 'soft', item: 'memlock', value: 'unlimited' }
    - { type: 'hard', item: 'memlock', value: 'unlimited' }

- name: Create CPU isolation script
  copy:
    dest: "{{ aeron_dir }}/bin/isolate-cpus.sh"
    mode: '0755'
    content: |
      #!/bin/bash
      # Isolate CPUs for Aeron benchmarking
      # Usage: ./isolate-cpus.sh <cpu_list>
      # Example: ./isolate-cpus.sh 2,3,4,5
      
      CPU_LIST=${1:-"2,3"}
      
      # Move interrupts to CPU 0
      for irq in /proc/irq/*/smp_affinity_list; do
        echo 0 > $irq 2>/dev/null || true
      done
      
      echo "CPUs $CPU_LIST isolated for Aeron"
      echo "Run benchmark with: taskset -c $CPU_LIST <command>"

- name: Get Aeron version from build
  shell: |
    cd {{ aeron_dir }}/aeron-src && git describe --tags --always 2>/dev/null || echo "latest"
  register: aeron_version_result
  changed_when: false

- name: Display installation summary
  debug:
    msg: |
      Aeron {{ aeron_version_result.stdout }} installed successfully!
      
      Location: {{ aeron_dir }}
      Source: {{ aeron_dir }}/aeron-src
      Java: OpenJDK {{ java_version }}
      
      Scripts:
        - {{ aeron_dir }}/bin/media-driver.sh  (Start media driver)
        - {{ aeron_dir }}/bin/ping.sh          (Latency benchmark)
        - {{ aeron_dir }}/bin/pong.sh          (Latency responder)
        - {{ aeron_dir }}/bin/throughput.sh    (Throughput benchmark)
